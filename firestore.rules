/**
 * @fileoverview Firestore Security Rules for the inventory system.
 *
 * Core Philosophy:
 * This ruleset allows read and write access to authenticated users for the main data collections.
 * It includes a specific rule for collection group queries on 'movements' to support the dashboard's activity log.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read and write access to any authenticated user for blocks.
     */
    match /blocks/{blockId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Grants read and write access to any authenticated user for sectors.
     */
    match /sectors/{sectorId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Grants read and write access to any authenticated user for rooms.
     */
    match /rooms/{roomId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Grants read and write access to any authenticated user for assets.
     * This rule also governs write access to the nested 'movements' subcollection.
     */
    match /assets/{assetId} {
      allow read, write: if isSignedIn();
      
      /**
       * @description Manages write access to the nested movements subcollection.
       * Allows creating and deleting logs for authenticated users.
       * Prevents modification of existing logs to ensure data integrity.
       */
      match /movements/{movementId} {
        allow create, delete: if isSignedIn();
        allow update: if false; // Deny updates to make logs immutable.
      }
    }
    
    /**
     * @description This rule allows a collection group query on 'movements'.
     * It's necessary for features like the "Recent Activity" feed on the dashboard,
     * which needs to query across all 'movements' subcollections.
     * It grants read (list) access to any authenticated user.
     */
    match /{path=**}/movements/{movementId} {
      allow list: if isSignedIn();
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}
