
/**
 * @fileoverview Firestore Security Rules for the inventory system.
 *
 * Core Philosophy:
 * This ruleset allows read and write access to any authenticated user. Since the application does not specify user-specific data or roles, the rules are open to all authenticated users.
 *
 * Data Structure:
 * The data is organized into five top-level collections: /blocks/{blockId}, /sectors/{sectorId}, /rooms/{roomId}, /assets/{assetId}, and /movements/{movementId}. There are no nested collections.
 *
 * Key Security Decisions:
 * - All authenticated users can read and write to all collections.
 * - There are no specific authorization requirements outlined besides basic authentication, so more granular access control is not implemented.
 * - No denormalization for authorization independence is required.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read and write access to any authenticated user for blocks.
     * @path /blocks/{blockId}
     * @allow (create, update, delete) - Any authenticated user can create, update, or delete a block.
     *   Example: request.auth.uid != null
     * @allow (get, list) - Any authenticated user can read a block.
     *   Example: request.auth.uid != null
     * @deny (create, update, delete) - An unauthenticated user attempts to create a block.
     *   Example: request.auth.uid == null
     * @principle Allows any authenticated user to read and write block data.
     */
    match /blocks/{blockId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Grants read and write access to any authenticated user for sectors.
     * @path /sectors/{sectorId}
     * @allow (create, update, delete) - Any authenticated user can create, update, or delete a sector.
     *   Example: request.auth.uid != null
     * @allow (get, list) - Any authenticated user can read a sector.
     *   Example: request.auth.uid != null
     * @deny (create, update, delete) - An unauthenticated user attempts to create a sector.
     *   Example: request.auth.uid == null
     * @principle Allows any authenticated user to read and write sector data.
     */
    match /sectors/{sectorId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Grants read and write access to any authenticated user for rooms.
     * @path /rooms/{roomId}
     * @allow (create, update, delete) - Any authenticated user can create, update, or delete a room.
     *   Example: request.auth.uid != null
     * @allow (get, list) - Any authenticated user can read a room.
     *   Example: request.auth.uid != null
     * @deny (create, update, delete) - An unauthenticated user attempts to create a room.
     *   Example: request.auth.uid == null
     * @principle Allows any authenticated user to read and write room data.
     */
    match /rooms/{roomId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Grants read and write access to any authenticated user for assets.
     * @path /assets/{assetId}
     * @allow (create, update, delete) - Any authenticated user can create, update, or delete an asset.
     *   Example: request.auth.uid != null
     * @allow (get, list) - Any authenticated user can read an asset.
     *   Example: request.auth.uid != null
     * @deny (create, update, delete) - An unauthenticated user attempts to create an asset.
     *   Example: request.auth.uid == null
     * @principle Allows any authenticated user to read and write asset data.
     */
    match /assets/{assetId} {
      allow read, write: if isSignedIn();
    }
    
    /**
     * @description Manages access to the movements collection.
     * Allows any authenticated user to query the collection, create new logs, and delete them.
     * Prevents modification of existing logs to ensure data integrity.
     */
    match /movements/{movementId} {
      // Allow authenticated users to query the collection (list), read single docs (get), create, and delete movement logs.
      allow list, get, create, delete: if isSignedIn();
      // Explicitly deny updates to make logs immutable once created.
      allow update: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}
